<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="tYMwPoxNrWfLx2sDrDYzqI4-dq3M3FfI56NBL9JNtH8" />

    <title>NestJS 1주차 과제</title>
    <meta name="description" content="A simple, whitespace, helvetica based portfolio theme.
">

    <link rel = "shortcut icon" type="image/x-icon" href="/img/square_logo.png">
    <link rel="stylesheet" href="/css/main.css">
<!--    <link rel="canonical" href="http://localhost:4000/posts/1st_term/study/2022-01-08-nestJs_study/">-->
    <link rel="canonical" href="/posts/1st_term/study/2022-01-08-nestJs_study/">

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- 카테고리 css -->
    <link rel="stylesheet" href="/css/pagination.css">
    <link href="/css/category.css" type="text/css" rel="stylesheet">
</head>

   
  <body>
    <script src="/js/default.js"></script>
    <header id="tab" >
  <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
  <div class="site-header">
    <div class="wrapper">
      <div>
        <a href="/">
          <img src="/img/square_logo.png" align="left" width="57px">
        </a>
      </div>

      <nav class="site-nav">

        <div id="tab" class="trigger">
          <!-- GDSC Seoultech instead of blog -->
          <a class="page-link" href="/">GDSC</a>
          <a class="page-link" href="/members/2">MEMBER</a>
          <a class="page-link" href="/category/2nd_term">POST</a>
        </div>
      </nav>
    </div>
  </div>

  <div id="hovering" class="tab-header">
    <div class="wrapper">
      <div class="detail-post">
          <div class="tab-item">
            <div><a class="page-link-detail" href="/category/1st_term">1기</a></div>
            <div><a class="page-link-detail" href="/category/2nd_term">2기</a></div>
          </div>
      </div>
      <div class="detail-member">
        <div class="tab-item">
          <div><a class="page-link-detail" href="/members/1">1기</a></div>
          <div><a class="page-link-detail" href="/members/2">2기</a></div>
        </div>
    </div>
    </div>

  </div>

  <script type="text/javascript">
    var tabMenu = $("#tab");
    var tabSubMenu = $("#hovering");

    tabSubMenu.hide()

    tabMenu.hover(function() {
      tabSubMenu.show();
    }, function() {
      tabSubMenu.hide();
    })
  </script>

</header>


    <div class="page-content" id="page-content">
      <div class="wrapper" id="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">NestJS 1주차 과제</h1>
    <h1 class="post-description">모두 화이팅!</h1>
    <p class="post-meta">January 8, 2022 — 00:00 • seongryool</p>
    
      
        <span class="tag">study</span>
      
    
  </header>
  <article class="post-content">
    <h1 id="nestjs-1주차-과제">NestJS 1주차 과제</h1>

<p>안녕하세요. NestJS 스터디에 참여하는 위성률입니다.<br />
이번 글에서는 NestJS 1주차 과제에 대해서 적어보겠습니다.</p>

<p><img src="https://user-images.githubusercontent.com/66999675/148632520-bf5bd516-6473-44ef-9f7d-91cf527919b7.png" alt="image" /></p>

<p>만들어야하는 데이터베이스 스키마와 과제는 위와 같습니다.</p>

<p>먼저 이번 NestJS 스터디에서는 TypeScript + NestJS + ORM + MySQL을 사용합니다.<br />
설치 과정또한 적어보겠습니다.</p>

<pre><code class="language-JavaScript">npm install -g @nestjs/cli
nest new hello-prisma
</code></pre>

<p>첫번째 코드를 통해서 nestjs/cli를 설치해주고 두번째 코드를 통해서 nestJS 프로젝트를 만들어줍니다.</p>

<pre><code class="language-JavaScript">npm install prisma --save-dev
npx prisma init
</code></pre>

<p>prisma를 설치해 주고 prisma를 로컬에서 호출해 줍니다.<br />
npx prisma init을 하게 되면 아래의 사진과 같이 폴더들이 만들어집니다.<br />
<img src="https://user-images.githubusercontent.com/66999675/148632582-238d865d-e536-49f6-97c8-913ed4d47f7f.png" alt="image" /></p>

<p>위와 같이 prisma 폴더에 schema.prisma가 생성됩니다.</p>

<p><img src="https://user-images.githubusercontent.com/66999675/148632594-ab6ea65d-4037-46f5-9463-bafe58efad6d.png" alt="image" /></p>

<p>mysql을 사용하기에 db의 provide를 mysql로 바꿔줍니다.
이제 MySQL로 갑니다.</p>

<p><img src="https://user-images.githubusercontent.com/66999675/148632610-ff7fa529-d646-4523-bcd6-930f378a88f9.png" alt="image" /><br />
아이디 root로 하고 port 3306으로 DB를 만들어줍니다.<br />
다시 nestJs .env 파일로 갑니다.</p>

<p><img src="https://user-images.githubusercontent.com/66999675/148632624-5e960399-6a09-4f42-b9ff-c8f0e9b1bd4a.png" alt="image" /></p>

<p>DATABASE_URL을 위와 같이 바꿔줍니다.<br />
root:DB 비밀번호@포트 번호/DB에 만들 스키마 이름</p>

<p>다시 schema.prisma 파일로 가서 스키마를 정의해줍니다.<br />
<img src="https://user-images.githubusercontent.com/66999675/148632817-238c1212-7ac7-449e-8bc1-120d5a49ea6f.png" alt="image" /><br />
1대 다 관계도 정의해 주고<br />
id에서는 @default(autoincrement())를 통해서 자동으로 값이 생성되게 해줍니다.<br />
@map(“created*at”) visual studio code에서 코드를 짤 때는 카멜 케이스 형식으로 변수명을 했지만<br />
DB에서는 *를 이용해야 하기에 map을 이용해서 바꿔줍니다.</p>

<pre><code class="language-JavaScript">npx prisma db push
</code></pre>

<p>를 통해서 mysql db와 연결을 해줍니다.<br />
<img src="https://user-images.githubusercontent.com/66999675/148632870-cf864f41-c073-4f30-bbbb-a39adcec2e6d.png" alt="image" /><br />
<img src="https://user-images.githubusercontent.com/66999675/148632884-bc60e05a-dbe0-41f4-a556-d4e20d1ce91e.png" alt="image" />
DB에 잘 들어간 걸 확인할 수 있습니다.</p>

<pre><code class="language-JavaScript">npm install @prisma/client
</code></pre>

<p>위의 코드를 통해서 prisma client를 설치해줍니다.<br />
앞으로 생성된 prisma client를 업데이트 하려면</p>

<pre><code class="language-JavaScript">npx prisma generate
</code></pre>

<p>코드를 사용하면 됩니다.<br />
<img src="https://user-images.githubusercontent.com/66999675/148632964-ca42f409-dc24-4370-8dca-1bbf476adf95.png" alt="image" /><br />
src 폴더 밑에 prisma 폴더를 만들고 prisma.service.ts 파일을 만들고 공식문서에 나와있는 코드를 추가합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nest g resource user
nest g resource board
nest g resource comment
</code></pre></div></div>

<p>nest g resource 폴더이름을 통해서 각 모델들의 service, controller, module ,dto 등을 한 번에 만들어줍니다.</p>

<h1 id="user">User</h1>

<p>User에 대한 기능부터 만들어보겠습니다.</p>

<p>크게 controller, service, repository 구조를 가집니다.<br />
로직 관련은 service에 로직 중 DB 관련은 repository에 넣습니다.<br />
이제 controller에서 service를 불러옵니다.</p>

<p>먼저 Dto를 만들어줍니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i --save class-validator class-transformer
</code></pre></div></div>

<p>또한 유효성 검사를 위해서 class-validate도 설치합니다.</p>

<p>createUserDto 파일로 가서 아래와 같이 코드를 작성해줍니다.</p>

<pre><code class="language-JavaScript">import {IsString, IsInt, IsNotEmpty, MaxLength, IsEmail, Max} from 'class-validator';

export class CreateUserDto {
  @IsString()
  @IsNotEmpty()
  email: string;

  @IsString()
  @IsNotEmpty()
  @MaxLength(10)
  nickname: string;

  @IsString()
  @IsNotEmpty()
  @MaxLength(12)
  password: string;
}
</code></pre>

<p>@ 데코레이터를 이용해서 유효성 검사를 해줍니다.<br />
user를 생성할 때는 default로 정의한 값들을 제외하고 user가 직접 넣어줘야하는 값들을 넣어줍니다.</p>

<p>updateUserDto로 가서 update에 필요한 값들을 넣어줍니다.<br />
user의 id를 확인해서 있으면 nickname을 바꾸기에 id, nickname을 넣어줍니다.</p>

<pre><code class="language-JavaScript">import {IsString, IsInt, IsNotEmpty, MaxLength, IsEmail, Max} from 'class-validator';
export class UpdateUserDto {
  @IsInt()
  @IsNotEmpty()
  id: number;

  @IsNotEmpty()
  @MaxLength(15)
  @IsString()
  nickname: string;
}
</code></pre>

<h3 id="usercontroller">UserController</h3>

<pre><code class="language-JavaScript">import {Controller, Get, Post, Body, Patch, Param, Delete} from '@nestjs/common';
import { UserService } from './user.service';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';

@Controller('user')
export class UserController {
  constructor(private readonly userService: UserService) {}

  @Post()
  create(@Body() createUserDto: CreateUserDto) {
    return this.userService.create(createUserDto);
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.userService.findOne(+id);
  }

  @Patch(':id')
  update(@Body() updateUserDto: UpdateUserDto) {
    return this.userService.update(updateUserDto);
  }
}
</code></pre>

<p>user 기능은 유저 생성, 1명 조회, 닉네임 변경만 있기에 위와 같이 바꿔줍니다.<br />
이제 레포지토리 패턴을 사용할 것이기에 repository 폴더를 만들고 그 아래에<br />
user.repository.ts를 만들어줍니다.</p>

<h3 id="userservice">UserService</h3>

<pre><code class="language-JavaScript">import { UserRepository } from './../repository/user.repository';
import { HttpException, Injectable } from '@nestjs/common';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';

@Injectable()
export class UserService {
  constructor(private userRepository: UserRepository) {}

  async create(createUserDto: CreateUserDto) {
    const emailFound = await this.userRepository.findEmail(createUserDto.email);
    //console.log('email : ', emailFound);
    if (emailFound) {
      throw new HttpException(`duplicated ${createUserDto.email}`, 400);
      //400은 BadRequest, 데이터요청
    }

    const nicknameFound = await this.userRepository.findNickName(
      createUserDto.nickname,
    );

    if (nicknameFound) {
      throw new HttpException(`duplicated ${createUserDto.nickname}`, 400);
      //400은 BadRequest, 데이터요청
    }
    return await this.userRepository.create(createUserDto);
  }

  async findOne(id: number) {
    const found = await this.userRepository.findOne(id);
    if (!found) {
      throw new HttpException(`there is no ${id}`, 400);
    }
    //password 같은 걸 해주면 안돼

    // delete found.password;
    const { password, id: userId, ...result } = found;
    return result;
  }

  async update(updateUserDto: UpdateUserDto) {
    const idFound = await this.userRepository.findOne(updateUserDto.id);

    if (!idFound) {
      throw new HttpException(`there is no ${updateUserDto.id}`, 400);
    }

    const nicknameFound = await this.userRepository.findNickName(
      updateUserDto.nickname,
    );

    if (nicknameFound) {
      throw new HttpException(`duplicated ${updateUserDto.nickname}`, 400);
      //400은 BadRequest, 데이터요청
    }
    return await this.userRepository.update(updateUserDto);
  }
}
</code></pre>

<p>먼저 create입니다.<br />
user를 만들 때 중복된 아이디와 닉네임이 있으면 안 되기에 이 둘을 예외 처리해 줍니다.<br />
둘 다 중복된 아이디가 없을 때만 create로 유저를 생성해 줍니다.</p>

<p>findOne에서는 아이디에 해당하는 유저를 찾아주고 user를 리턴해줍니다.<br />
이때 유저가 없다면 예외를 발생시켜주고 있다면 user를 리턴해주돼 중요한 정보인 password는<br />
제외하고 return 해줍니다.</p>

<p>update에서는 id와 nickname을 활용합니다.<br />
먼저 id가 없는 걸 update 할 수 없기에 예외 처리를 해주고<br />
nickname이 중복되면 안 되기에 이것 또한 예외 처리를 해줍니다.</p>

<p>id가 있고 nickname이 중복이 안되면 update 해줍니다.<br />
service에서는 로직과 관련된 예외 처리를 해줍니다.<br />
DB 관련한 건 repository에 만들어줍니다.</p>

<h3 id="userrepository">UserRepository</h3>

<pre><code class="language-JavaScript">import { PrismaService } from './../prisma/prisma.service';
import { Injectable } from '@nestjs/common';
import { CreateUserDto } from 'src/user/dto/create-user.dto';
import { UpdateUserDto } from 'src/user/dto/update-user.dto';

@Injectable()
export class UserRepository {
  constructor(private prisma: PrismaService) {}

  async create(createUserDto: CreateUserDto) {
    const { email, password, nickname } = createUserDto;

    return await this.prisma.user.create({
      data: {
        email,
        password,
        nickname,
      },
    });
  }

  async findEmail(email: string) {
    return await this.prisma.user.findUnique({
      where: {
        email,
      },
    });
  }

  async findNickName(nickname: string) {
    return await this.prisma.user.findUnique({
      where: {
        nickname,
      },
    });
  }
  async findOne(id: number) {
    return await this.prisma.user.findUnique({
      where: {
        id,
      },
    });
  }

  async update(updateUserDto: UpdateUserDto) {
    const { id, nickname } = updateUserDto;
    return await this.prisma.user.update({
      where: {
        id,
      },
      data: {
        nickname,
      },
    });
  }
}
</code></pre>

<p>repository의 create는 prisma의 create를 이용해서 DB에 user를 생성합니다.<br />
findId, findEmail, findNickname은 DB에서 각각 조건에 맞는 user들을 찾아줍니다.<br />
하나로 만들 수 있다는데 다시 해봐야 되겠습니다.<br />
update는 먼저 조건에 맞는 id를 찾아주고 nickname을 update 해줍니다.</p>

<p>service와 repository에 둘 다 async await를 이용해서 비동기를 동기처럼 할 수 있게 만들어줍니다.</p>

<p>comment와 board도 유사한 과정으로 하면 되기에 user까지만 작성하겠습니다.<br />
너무 재밌습니다!</p>

  </article>
  <br>

  <hr/><br>

  <div class="author">
    
    <table>
        <tr>
          <td rowspan="3" style="padding-right: 10px"><img class="author-pic" src="https://github.com/.png" alt=""></td>
          <td><b><h2 rel="author"></h2></b></td>
        </tr>
      <tr>
        <td><p rel="author"></p>
        </td>
      </tr>
      <tr>
        <td>
          <a rel="author" href="https://github.com/" target="_blank"><i class="fa fa-github fa-2x"></i></a>&nbsp&nbsp
          
        </td>
      </tr>
    </table>

  </div>


  <br>
  <hr/>
  <div>
    <script src="https://utteranc.es/client.js"
        repo="gdsc-seoultech/blog-comments"
        issue-term="pathname"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
    </script>
  </div>

</div>
<script src="/js/toc.js"></script>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper" align="center">
  	<h4>This site was built using <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and is hosted on <a href="https://github.com" target="_blank">Github</a>. &#169; GDSC Seoultech</h4>
  </div>

</footer>


  </body>
</html>
